<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Confidential Access Request</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px auto;
      max-width: 600px;
      text-align: center;
    }

    #queue-wait,
    #puzzle-container,
    #final-visual-check,
    #final-password,
    #download-section {
      margin-top: 20px;
    }

    #puzzle-container {
      display: none;
    }

    .step {
      display: none;
      margin-bottom: 20px;
    }

    .step h2 {
      margin-bottom: 10px;
    }

    .step .question {
      font-weight: bold;
      margin-bottom: 8px;
    }

    .step .result {
      color: red;
      margin-top: 8px;
    }

    .button {
      display: inline-block;
      padding: 10px 20px;
      margin: 10px;
      font-size: 1rem;
      cursor: pointer;
      background-color: #007BFF;
      color: white;
      border-radius: 4px;
      text-decoration: none;
      border: none;
    }

    .button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }

    .video-embed {
      width: 100%;
      height: 315px;
      margin-top: 10px;
    }

    /* Final visual check */
    #final-visual-check {
      display: none;
      margin-top: 20px;
    }
    .image-option {
      display: inline-block;
      margin: 10px;
      cursor: pointer;
    }
    .image-option img {
      width: 100px;
      height: 100px;
      border: 2px solid #ccc;
      border-radius: 8px;
    }
    #visual-result {
      margin-top: 10px;
      color: red;
      font-weight: bold;
    }

    /* Final password + download */
    #final-password {
      display: none;
      margin-top: 20px;
      font-size: 1.2rem;
      color: green;
      font-weight: bold;
    }
    #download-section {
      display: none;
      margin-top: 30px;
    }
  </style>
</head>
<body>
  <!-- 1) Fake Queue Section -->
  <div id="queue-wait">
    <p><strong>Queue Status</strong></p>
    <p id="queue-info"></p>
  </div>

  <!-- 2) Security Steps (puzzles) -->
  <div id="puzzle-container">
    <!-- We'll fill each step with content based on our data array. -->
    <div class="step" id="step0">
      <h2>Security Step 1</h2>
      <div class="question" id="question0"></div>
      <div id="video-0" style="display:none;">
        <iframe 
          class="video-embed"
          src="https://www.youtube.com/embed/J---aiyznGQ?enablejsapi=1"
          frameborder="0"
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
          allowfullscreen>
        </iframe>
        <p>Please watch at least 10 seconds of this mandatory video before clicking Submit.</p>
      </div>
      <input type="text" id="answer0" style="display:none;" />
      <button class="button" id="submit0" onclick="submitAnswer(0)">Submit</button>
      <div class="result" id="result0"></div>
    </div>

    <div class="step" id="step1">
      <h2>Security Step 2</h2>
      <div class="question" id="question1"></div>
      <div id="video-1" style="display:none;">
        <iframe 
          class="video-embed"
          src="https://www.youtube.com/embed/J---aiyznGQ?enablejsapi=1"
          frameborder="0"
          allowfullscreen>
        </iframe>
        <p>Please watch at least 10 seconds of this mandatory video before clicking Submit.</p>
      </div>
      <input type="text" id="answer1" style="display:none;" />
      <button class="button" id="submit1" onclick="submitAnswer(1)">Submit</button>
      <div class="result" id="result1"></div>
    </div>

    <div class="step" id="step2">
      <h2>Security Step 3</h2>
      <div class="question" id="question2"></div>
      <div id="video-2" style="display:none;">
        <iframe 
          class="video-embed"
          src="https://www.youtube.com/embed/J---aiyznGQ?enablejsapi=1"
          frameborder="0"
          allowfullscreen>
        </iframe>
        <p>Please watch at least 10 seconds of this mandatory video before clicking Submit.</p>
      </div>
      <input type="text" id="answer2" style="display:none;" />
      <button class="button" id="submit2" onclick="submitAnswer(2)">Submit</button>
      <div class="result" id="result2"></div>
    </div>

    <div class="step" id="step3">
      <h2>Security Step 4</h2>
      <div class="question" id="question3"></div>
      <div id="video-3" style="display:none;">
        <iframe 
          class="video-embed"
          src="https://www.youtube.com/embed/J---aiyznGQ?enablejsapi=1"
          frameborder="0"
          allowfullscreen>
        </iframe>
        <p>Please watch at least 10 seconds of this mandatory video before clicking Submit.</p>
      </div>
      <input type="text" id="answer3" style="display:none;" />
      <button class="button" id="submit3" onclick="submitAnswer(3)">Submit</button>
      <div class="result" id="result3"></div>
    </div>

    <div class="step" id="step4">
      <h2>Security Step 5</h2>
      <div class="question" id="question4"></div>
      <div id="video-4" style="display:none;">
        <iframe 
          class="video-embed"
          src="https://www.youtube.com/embed/J---aiyznGQ?enablejsapi=1"
          frameborder="0"
          allowfullscreen>
        </iframe>
        <p>Please watch at least 10 seconds of this mandatory video before clicking Submit.</p>
      </div>
      <input type="text" id="answer4" style="display:none;" />
      <button class="button" id="submit4" onclick="submitAnswer(4)">Submit</button>
      <div class="result" id="result4"></div>
    </div>

    <div class="step" id="step5">
      <h2>Security Step 6</h2>
      <div class="question" id="question5"></div>
      <div id="video-5" style="display:none;">
        <iframe 
          class="video-embed"
          src="https://www.youtube.com/embed/J---aiyznGQ?enablejsapi=1"
          frameborder="0"
          allowfullscreen>
        </iframe>
        <p>Please watch at least 10 seconds of this mandatory video before clicking Submit.</p>
      </div>
      <input type="text" id="answer5" style="display:none;" />
      <button class="button" id="submit5" onclick="submitAnswer(5)">Submit</button>
      <div class="result" id="result5"></div>
    </div>

    <div class="step" id="step6">
      <h2>Security Step 7</h2>
      <div class="question" id="question6"></div>
      <div id="video-6" style="display:none;">
        <iframe 
          class="video-embed"
          src="https://www.youtube.com/embed/J---aiyznGQ?enablejsapi=1"
          frameborder="0"
          allowfullscreen>
        </iframe>
        <p>Please watch at least 10 seconds of this mandatory video before clicking Submit.</p>
      </div>
      <input type="text" id="answer6" style="display:none;" />
      <button class="button" id="submit6" onclick="submitAnswer(6)">Submit</button>
      <div class="result" id="result6"></div>
    </div>

    <div class="step" id="step7">
      <h2>Security Step 8</h2>
      <div class="question" id="question7"></div>
      <div id="video-7" style="display:none;">
        <iframe 
          class="video-embed"
          src="https://www.youtube.com/embed/J---aiyznGQ?enablejsapi=1"
          frameborder="0"
          allowfullscreen>
        </iframe>
        <p>Please watch at least 10 seconds of this mandatory video before clicking Submit.</p>
      </div>
      <input type="text" id="answer7" style="display:none;" />
      <button class="button" id="submit7" onclick="submitAnswer(7)">Submit</button>
      <div class="result" id="result7"></div>
    </div>
  </div>

  <!-- 3) Final Visual Check -->
  <div id="final-visual-check">
    <h2>Final Security Check</h2>
    <p>Pick the correct shape below to finalize your request.</p>
    <div id="shapes">
      <div class="image-option" data-correct="false" onclick="checkShape(this)">
        <img src="https://via.placeholder.com/100/FF0000/FFFFFF?text=Triangle" alt="Triangle">
      </div>
      <div class="image-option" data-correct="false" onclick="checkShape(this)">
        <img src="https://via.placeholder.com/100/00FF00/000000?text=Square" alt="Square">
      </div>
      <div class="image-option" data-correct="true" onclick="checkShape(this)">
        <img src="https://via.placeholder.com/100/0000FF/FFFFFF?text=Circle" alt="Circle">
      </div>
      <div class="image-option" data-correct="false" onclick="checkShape(this)">
        <img src="https://via.placeholder.com/100/FFFF00/000000?text=Star" alt="Star">
      </div>
    </div>
    <div id="visual-result"></div>
  </div>

  <!-- 4) Reveal ZIP Password -->
  <div id="final-password"></div>

  <!-- 5) Download Section -->
  <div id="download-section">
    <p>Please use the password above to open the ZIP file:</p>
    <a href="doctors_note.zip" download class="button">Download ZIP File</a>
  </div>

  <script>
    /***************************************************
     * GLOBAL CONSTANTS & VARIABLES
     ***************************************************/
    // The *actual* wait time in seconds before letting them move on (hidden countdown)
    const REAL_WAIT_TIME = 300;

    // We'll keep track of how many people are ahead in the queue (fake), and an "estimated time."
    let peopleInQueue = 0;         // will be set randomly below
    let estimatedTime = 0;         // (in minutes) also random

    // We'll do random fluctuations every few seconds
    let queueTimerInterval = null;
    let realWaitTimerInterval = null;
    let realWaitRemaining = REAL_WAIT_TIME;

    // Puzzle data (8 puzzles). Some are "video" type, some are "text" type
    // Adjust the questions and correct answers as desired.
    const puzzles = [
      { type: "text", question: "What is 2 + 2?", answer: "4" },
      { type: "text", question: "Spell 'confidential' backward.", answer: "laitnedifnoc" },
      { type: "text", question: "Enter 'blue' in lowercase.", answer: "blue" },
      { type: "text", question: "What is 15 divided by 3?", answer: "5" },
      { type: "text", question: "Type 'i will abide by all confidentiality rules.' exactly.", answer: "i will abide by all confidentiality rules." },
      { type: "video", question: "Watch the mandatory video for at least 10 seconds, then click Submit.", answer: "dummy1" },
      { type: "text", question: "What is 10 - 3?", answer: "7" },
      { type: "video", question: "Watch this mandatory video for 10 seconds before submitting.", answer: "dummy2" }
    ];

    // Shuffle puzzle order
    let puzzleOrder = shuffle([...Array(puzzles.length).keys()]);
    let currentPuzzleIndex = 0;

    // For the "video" puzzle: track how many seconds they've watched
    let videoWatchTime = 0;
    let videoInterval = null;

    // Encoded ZIP password (original is "125152113126" -> base64: "MTI1MTUyMTEzMTI2")
    const encodedPassword = "MTI1MTUyMTEzMTI2";

    /***************************************************
     * PAGE LOAD
     ***************************************************/
    window.onload = function() {
      // Initialize random queue values
      peopleInQueue = getRandomInt(20, 50);     // e.g. 20-50 people
      estimatedTime = getRandomInt(3, 15);      // 3-15 minutes
      updateQueueInfo();

      // Start the queue update timer (random fluctuations)
      queueTimerInterval = setInterval(fluctuateQueue, 4000); // every 4s

      // Start the real hidden countdown
      realWaitTimerInterval = setInterval(() => {
        if (realWaitRemaining <= 0) {
          clearInterval(realWaitTimerInterval);
          clearInterval(queueTimerInterval);
          // Force queue display to 0
          peopleInQueue = 0;
          estimatedTime = 0;
          updateQueueInfo();
          // Show puzzle container
          document.getElementById("puzzle-container").style.display = "block";
          document.getElementById("queue-wait").style.display = "none";
          showPuzzle(0);
        } else {
          realWaitRemaining--;
        }
      }, 1000);
    };

    /***************************************************
     * QUEUE LOGIC
     ***************************************************/
    // Randomly change peopleInQueue and estimatedTime
    function fluctuateQueue() {
      // random +/- to peopleInQueue
      let change = getRandomInt(-2, 3);  // can go down by 2, up by 2
      peopleInQueue += change;
      if (peopleInQueue < 0) peopleInQueue = 0;
      if (peopleInQueue > 60) peopleInQueue = 60;

      // random +/- to estimatedTime
      let timeChange = getRandomInt(-1, 1); // can go down 1 min or up 1 min or 0
      estimatedTime += timeChange;
      if (estimatedTime < 1) estimatedTime = getRandomInt(1,3); // never show 0 too soon
      if (estimatedTime > 30) estimatedTime = 30;

      updateQueueInfo();
    }

    function updateQueueInfo() {
      const queueText = `There are currently ${peopleInQueue} request(s) ahead of you.<br>
        Estimated time: ~${estimatedTime} minute(s)`;
      document.getElementById("queue-info").innerHTML = queueText;
    }

    /***************************************************
     * SECURITY STEPS (PUZZLES)
     ***************************************************/
    // Shuffle array
    function shuffle(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    // Show puzzle in the shuffled order
    function showPuzzle(index) {
      // Hide all steps first
      const steps = document.querySelectorAll('.step');
      steps.forEach(s => s.style.display = 'none');

      if (index >= puzzles.length) {
        // If done with all steps, proceed to final visual check
        document.getElementById("puzzle-container").style.display = "none";
        document.getElementById("final-visual-check").style.display = "block";
        return;
      }

      // Show the correct step
      const stepElem = document.getElementById(`step${index}`);
      stepElem.style.display = "block";

      // Fill question text
      const puzzleId = puzzleOrder[index];
      const puzzleObj = puzzles[puzzleId];
      document.getElementById(`question${index}`).textContent = puzzleObj.question;

      // Show/hide video or input
      const videoDiv = document.getElementById(`video-${index}`);
      const inputField = document.getElementById(`answer${index}`);
      videoDiv.style.display = "none";
      inputField.style.display = "none";

      if (puzzleObj.type === "video") {
        // Start counting watch time
        videoDiv.style.display = "block";
        videoWatchTime = 0;
        clearInterval(videoInterval);
        videoInterval = setInterval(() => {
          videoWatchTime++;
        }, 1000);
      } else {
        // text puzzle
        inputField.style.display = "inline-block";
      }
    }

    // Submit answer
    function submitAnswer(index) {
      const puzzleId = puzzleOrder[index];
      const puzzleObj = puzzles[puzzleId];
      const resultElem = document.getElementById(`result${index}`);
      resultElem.textContent = "";

      if (puzzleObj.type === "video") {
        // Must watch at least 10 seconds
        if (videoWatchTime >= 10) {
          clearInterval(videoInterval);
          resultElem.textContent = "Passed.";
          resultElem.style.color = "green";
          goNext();
        } else {
          // Fail
          window.location.href = "failure.html";
        }
      } else {
        // Text puzzle
        const userVal = document.getElementById(`answer${index}`).value.trim().toLowerCase();
        if (userVal === puzzleObj.answer) {
          resultElem.textContent = "Passed.";
          resultElem.style.color = "green";
          goNext();
        } else {
          window.location.href = "failure.html";
        }
      }
    }

    function goNext() {
      currentPuzzleIndex++;
      showPuzzle(currentPuzzleIndex);
    }

    /***************************************************
     * FINAL VISUAL CHECK
     ***************************************************/
    function checkShape(el) {
      const correct = el.getAttribute("data-correct");
      const visualResult = document.getElementById("visual-result");
      if (correct === "true") {
        visualResult.textContent = "Access Granted.";
        visualResult.style.color = "green";
        revealPassword();
      } else {
        window.location.href = "failure.html";
      }
    }

    function revealPassword() {
      // Decode the base64-encoded password (original: 125152113126)
      const decoded = decodeBase64(encodedPassword);
      const finalPassDiv = document.getElementById("final-password");
      finalPassDiv.textContent = "Decryption Key: " + decoded; 
      finalPassDiv.style.display = "block";

      // Show download link
      document.getElementById("download-section").style.display = "block";
    }

    function decodeBase64(str) {
      return atob(str);
    }

    /***************************************************
     * HELPER FUNCTION
     ***************************************************/
    // Returns a random integer between min and max (inclusive)
    function getRandomInt(min, max) {
      const r = Math.floor(Math.random() * (max - min + 1)) + min;
      return r;
    }
  </script>
</body>
</html>
